<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tong-Its Multiplayer</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --primary: #0d6efd;
            --success: #198754;
            --danger: #dc3545;
            --warning: #ffc107;
            --dark: #212529;
        }
        body {
            background: linear-gradient(135deg, #1e3c72, #2a5298);
            color: white;
            min-height: 100vh;
            font-family: 'Segoe UI', sans-serif;
        }
        .game-container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        .player-area {
            background: rgba(255,255,255,0.1);
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
            min-height: 220px;
            border: 3px solid transparent;
            transition: all 0.3s;
        }
        .player-area.turn {
            border-color: var(--warning);
            box-shadow: 0 0 20px rgba(255,193,7,0.6);
            transform: scale(1.02);
        }
        .card {
            width: 70px; height: 100px;
            background: white; color: #333;
            border-radius: 10px; margin: 4px;
            display: inline-flex; flex-direction: column;
            justify-content: center; align-items: center;
            font-weight: bold; cursor: pointer;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            transition: all 0.2s;
            user-select: none;
        }
        .card:hover { transform: translateY(-8px); }
        .card.selected { border: 4px solid gold; transform: translateY(-15px); }
        .card.red { color: #d63031; }
        .card.black { color: #2d3436; }
        .card.back {
            background: linear-gradient(45deg, #8B0000, #B22222);
            color: white;
        }
        .card.back::before { content: "T"; font-size: 2.5rem; opacity: 0.8; }
        .card-value { font-size: 1.6rem; }
        .card-suit { font-size: 1.4rem; margin-top: 4px; }
        .pile {
            width: 90px; height: 130px;
            background: rgba(255,255,255,0.15);
            border: 3px dashed rgba(255,255,255,0.4);
            border-radius: 12px;
            display: flex; align-items: center; justify-content: center;
            cursor: pointer; transition: 0.3s;
        }
        .pile:hover { background: rgba(255,255,255,0.3); }
        .melds-area { margin-top: 15px; }
        .meld {
            display: inline-block;
            background: rgba(0,0,0,0.2);
            padding: 10px;
            border-radius: 10px;
            margin: 8px;
        }
        .game-log {
            background: rgba(0,0,0,0.4);
            height: 180px;
            overflow-y: auto;
            border-radius: 10px;
            padding: 15px;
            font-size: 0.9rem;
        }
        .connection-status {
            padding: 8px 16px;
            border-radius: 30px;
            font-weight: bold;
            display: inline-block;
        }
        .status-connected { background: rgba(25,135,84,0.3); color: #28a745; border: 1px solid #28a745; }
        .status-disconnected { background: rgba(220,53,69,0.3); color: #dc3545; border: 1px solid #dc3545; }
        .status-connecting { background: rgba(255,193,7,0.3); color: #ffc107; border: 1px solid #ffc107; }
        @media (max-width: 768px) {
            .card { width: 50px; height: 75px; }
            .card-value { font-size: 1.2rem; }
            .pile { width: 70px; height: 100px; }
        }
    </style>
</head>
<body>

<!-- Lobby -->
<div id="lobby" class="container text-center py-5">
    <h1 class="display-4 fw-bold mb-3">Tong-Its</h1>
    <p class="lead mb-4">Filipino Rummy Card Game â€¢ 3 Players</p>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <div class="card bg-dark text-white border-0 shadow-lg">
                <div class="card-body p-5">
                    <div class="mb-4">
                        <span class="connection-status status-disconnected" id="conn-status">Disconnected</span>
                    </div>

                    <div id="host-card" class="alert alert-warning d-none">
                        <strong>Your Game ID:</strong><br>
                        <h3 class="mt-2" id="host-id">------</h3>
                        <button class="btn btn-sm btn-outline-light mt-2" onclick="copyId()">
                            <i class="fas fa-copy"></i> Copy
                        </button>
                    </div>

                    <div class="d-grid gap-3">
                        <button class="btn btn-primary btn-lg" id="host-btn">
                            <i class="fas fa-plus-circle"></i> Create Game
                        </button>
                        <div class="input-group">
                            <input type="text" class="form-control" id="join-input" placeholder="Enter Game ID">
                            <button class="btn btn-success" id="join-btn">Join</button>
                        </div>
                    </div>

                    <hr class="my-4">
                    <h5>Players (<span id="player-count">1</span>/3)</h5>
                    <ul class="list-group mt-3" id="player-list">
                        <li class="list-group-item bg-secondary">Waiting for players...</li>
                    </ul>

                    <button class="btn btn-success btn-lg mt-4 w-100" id="start-btn" disabled>
                        <i class="fas fa-play"></i> Start Game
                    </button>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Game Screen -->
<div id="game" class="game-container d-none">
    <div class="text-center mb-3">
        <h1><i class="fas fa-cards"></i> Tong-Its</h1>
        <div>
            Room: <strong id="room-id">---- </strong> |
            <span class="connection-status status-connected" id="game-conn">Connected</span>
        </div>
        <button class="btn btn-danger btn-sm mt-2" id="leave-btn">Leave Game</button>
    </div>

    <!-- Opponent Top -->
    <div class="player-area text-center" id="p2-area">
        <h4 id="p2-name">Player 2</h4>
        <div id="p2-hand"></div>
        <div id="p2-melds" class="melds-area"></div>
        <small>Cards: <span id="p2-count">12</span></small>
    </div>

    <div class="d-flex justify-content-center gap-5 my-4">
        <div class="text-center">
            <div class="pile" id="draw-pile"><i class="fas fa-layer-group fa-3x"></i></div>
            <div>Draw (<span id="draw-count">0</span>)</div>
        </div>
        <div class="text-center">
            <div class="pile" id="discard-pile"><i class="fas fa-ban fa-3x text-muted"></i></div>
            <div>Discard</div>
        </div>
    </div>

    <!-- Your Hand (Bottom) -->
    <div class="player-area turn" id="p1-area">
        <h4 id="p1-name">You</h4>
        <div id="p1-hand"></div>
        <div id="p1-melds" class="melds-area"></div>
        <small>Cards: <span id="p1-count">0</span></small>
    </div>

    <!-- Opponent Right -->
    <div class="player-area text-center" id="p3-area">
        <h4 id="p3-name">Player 3</h4>
        <div id="p3-hand"></div>
        <div id="p3-melds" class="melds-area"></div>
        <small>Cards: <span id="p3-count">12</span></small>
    </div>

    <div class="text-center my-4">
        <button class="btn btn-warning" id="draw-btn">Draw</button>
        <button class="btn btn-primary" id="meld-btn" disabled>Meld</button>
        <button class="btn btn-danger" id="discard-btn" disabled>Discard</button>
        <button class="btn btn-info" id="sapaw-btn" disabled>Sapaw</button>
        <button class="btn btn-success" id="tongits-btn" disabled>Tong-Its!</button>
    </div>

    <div class="game-log mt-4" id="log"></div>
</div>

<!-- Modals -->
<div class="modal fade" id="winModal">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-success text-white">
                <h5><i class="fas fa-trophy"></i> Game Over!</h5>
            </div>
            <div class="modal-body text-center" id="win-message"></div>
            <div class="modal-footer">
                <button class="btn btn-primary" onclick="location.reload()">New Game</button>
            </div>
        </div>
    </div>
</div>

<script src="https://unpkg.com/peerjs@1.5.4/dist/peerjs.min.js"></script>
<script>
    const suits = ['â™¥','â™¦','â™£','â™ '];
    const values = ['2','3','4','5','6','7','8','9','10','J','Q','K','A'];
    const suitNames = ['hearts','diamonds','clubs','spades'];

    let peer = null, myId = '', conn = null, isHost = false;
    let myPos = -1, players = ['', '', ''];
    let hand = [], melds = [], drawPile = 39, discardTop = null;
    let selected = [], turn = 0, phase = 'draw';

    const state = {
        hands: [[],[],[]],
        melds: [[],[],[]],
        drawPile: 39,
        discard: [],
        turn: 0,
        phase: 'draw'
    };

    function log(msg) {
        const el = document.createElement('div');
        el.innerHTML = `<small>${new Date().toLocaleTimeString()}</small> ${msg}`;
        document.getElementById('log').appendChild(el);
        el.scrollIntoView();
    }

    function initPeer() {
        myId = 'tongits_' + Math.random().toString(36).substr(2, 9);
        peer = new Peer(myId);
        peer.on('open', id => {
            document.getElementById('conn-status').textContent = 'Ready';
            document.getElementById('conn-status').className = 'connection-status status-connecting';
            log('Connected to PeerJS server');
        });

        peer.on('connection', c => {
            if (conn) c.close();
            conn = c;
            setupConn(conn);
            log('Player connected');
        });
    }

    function setupConn(c) {
        c.on('open', () => {
            conn = c;
            updateConnStatus('Connected', 'status-connected');
            if (!isHost) c.send({type: 'join', id: myId});
        });
        c.on('data', data => handleData(data));
        c.on('close', () => {
            conn = null;
            updateConnStatus('Disconnected', 'status-disconnected');
            log('Player disconnected');
        });
    }

    function handleData(data) {
        if (data.type === 'join') {
            const pos = players.indexOf('');
            if (pos === -1) return;
            players[pos] = data.id;
            myPos = pos;
            updatePlayers();
            if (isHost) broadcast({type: 'players', list: players});
        }
        if (data.type === 'players') {
            players = data.list;
            myPos = players.indexOf(myId);
            updatePlayers();
        }
        if (data.type === 'start') {
            startGame(data.state);
        }
        if (data.type === 'action') {
            applyAction(data.action, data.payload);
        }
        if (data.type === 'win') {
            showWin(data.winner);
        }
    }

    function broadcast(obj) {
        if (!conn || !conn.open) return;
        conn.send(obj);
    }

    document.getElementById('host-btn').onclick = () => {
        isHost = true;
        players[0] = myId;
        myPos = 0;
        document.getElementById('host-card').classList.remove('d-none');
        document.getElementById('host-id').textContent = myId;
        updatePlayers();
        updateConnStatus('Waiting for players...', 'status-connecting');
        log('Hosting game. Share ID: ' + myId);
    };

    document.getElementById('join-btn').onclick = () => {
        const id = document.getElementById('join-input').value.trim();
        if (!id) return alert('Enter Game ID');
        conn = peer.connect(id);
        setupConn(conn);
    };

    document.getElementById('start-btn').onclick = () => {
        if (!isHost) return;
        const deck = createDeck();
        shuffle(deck);
        state.hands = [[...deck.splice(0,13)], [...deck.splice(0,12)], [...deck.splice(0,12)]];
        state.discard = [deck.pop()];
        state.drawPile = deck.length;
        broadcast({type: 'start', state});
        startGame(state);
    };

    function startGame(s) {
        Object.assign(state, s);
        hand = state.hands[myPos];
        drawPile = state.drawPile;
        discardTop = state.discard[state.discard.length-1];
        turn = state.turn;
        phase = state.phase;
        document.getElementById('lobby').classList.add('d-none');
        document.getElementById('game').classList.remove('d-none');
        document.getElementById('room-id').textContent = isHost ? myId : conn.peer;
        render();
    }

    function render() {
        ['p1','p2','p3'].forEach((p,i) => {
            const area = document.getElementById(p+'-area');
            area.classList.toggle('turn', turn === i);
            document.getElementById(p+'-name').textContent = i === myPos ? 'You' : `Player ${i+1}`;
            document.getElementById(p+'-count').textContent = state.hands[i].length;
            document.getElementById(p+'-hand').innerHTML = i === myPos ? renderHand(state.hands[i]) : backCards(state.hands[i].length);
            document.getElementById(p+'-melds').innerHTML = renderMelds(state.melds[i]);
        });
        document.getElementById('draw-count').textContent = state.drawPile;
        document.getElementById('discard-pile').innerHTML = discardTop ? cardHTML(discardTop) : '<i class="fas fa-ban fa-3x text-muted"></i>';
        updateButtons();
    }

    function renderHand(cards) {
        return cards.map((c,i) => {
            const el = cardHTML(c);
            el.dataset.idx = i;
            el.onclick = () => toggleSelect(i);
            if (selected.includes(i)) el.classList.add('selected');
            return el.outerHTML;
        }).join('');
    }

    function cardHTML(c) {
        const div = document.createElement('div');
        div.className = `card ${c.suit === 'â™¥' || c.suit === 'â™¦' ? 'red' : 'black'}`;
        div.innerHTML = `<div class="card-value">${c.value}</div><div class="card-suit">${c.suit}</div>`;
        return div;
    }

    function backCards(n) {
        return Array(n).fill().map(() => '<div class="card back"></div>').join('');
    }

    function renderMelds(melds) {
        return melds.map(m => {
            const div = document.createElement('div');
            div.className = 'meld';
            m.forEach(c => div.appendChild(cardHTML(c)));
            return div.outerHTML;
        }).join('');
    }

    function toggleSelect(i) {
        if (turn !== myPos || phase === 'draw') return;
        const idx = selected.indexOf(i);
        if (idx > -1) selected.splice(idx, 1);
        else selected.push(i);
        render();
    }

    function updateButtons() {
        const isMyTurn = turn === myPos;
        document.getElementById('draw-btn').disabled = !isMyTurn || phase !== 'draw';
        document.getElementById('meld-btn').disabled = !isMyTurn || selected.length < 3;
        document.getElementById('discard-btn').disabled = !isMyTurn || selected.length !== 1;
        document.getElementById('sapaw-btn').disabled = !isMyTurn || selected.length !== 1;
        document.getElementById('tongits-btn').disabled = !isMyTurn || hand.length > 0;
    }

    document.getElementById('draw-btn').onclick = () => {
        if (phase !== 'draw') return;
        broadcast({type: 'action', action: 'draw', payload: {fromDiscard: false}});
        applyAction('draw', {fromDiscard: false});
    };

    document.getElementById('discard-pile').onclick = () => {
        if (phase !== 'draw' || !discardTop) return;
        broadcast({type: 'action', action: 'draw', payload: {fromDiscard: true}});
        applyAction('draw', {fromDiscard: true});
    };

    document.getElementById('meld-btn').onclick = () => {
        const cards = selected.map(i => hand[i]);
        if (!isValidMeld(cards)) return alert('Invalid meld!');
        broadcast({type: 'action', action: 'meld', payload: selected});
        applyAction('meld', selected);
    };

    document.getElementById('discard-btn').onclick = () => {
        if (selected.length !== 1) return;
        broadcast({type: 'action', action: 'discard', payload: selected[0]});
        applyAction('discard', selected[0]);
    };

    document.getElementById('tongits-btn').onclick = () => {
        broadcast({type: 'action', action: 'tongits'});
        showWin(players[turn]);
    };

    function applyAction(action, payload) {
        if (action === 'draw') {
            const card = payload.fromDiscard ? state.discard.pop() : {suit: suits[Math.floor(Math.random()*4)], value: values[Math.random()*13|0]};
            if (payload.fromDiscard) discardTop = state.discard[state.discard.length-1] || null;
            else state.drawPile--;
            state.hands[myPos].push(card);
            hand = state.hands[myPos];
            phase = 'play';
        }
        if (action === 'meld') {
            const cards = payload.sort((a,b)=>b-a).map(i => hand[i]);
            payload.forEach(i => hand.splice(i,1));
            state.melds[myPos].push(cards);
            selected = [];
            phase = 'play';
        }
        if (action === 'discard') {
            const card = hand[payload];
            hand.splice(payload, 1);
            state.discard.push(card);
            discardTop = card;
            selected = [];
            turn = (turn + 1) % 3;
            phase = 'draw';
        }
        if (action === 'tongits') {
            broadcast({type: 'win', winner: players[turn]});
            showWin(players[turn]);
        }
        render();
    }

    function isValidMeld(cards) {
        if (cards.length < 3) return false;
        const values = cards.map(c=>c.value);
        const suits = cards.map(c=>c.suit);
        const set = values.every(v=>v===values[0]);
        const run = suits.every(s=>s===suits[0]) && values.slice(1).every((v,i)=>values.indexOf(v) === values.indexOf(values[i])+1);
        return set || run;
    }

    function updatePlayers() {
        const list = document.getElementById('player-list');
        list.innerHTML = '';
        players.forEach((p,i) => {
            const li = document.createElement('li');
            li.className = 'list-group-item d-flex justify-content-between';
            li.innerHTML = `<span>${p ? (p===myId?'You':p.slice(8)) : 'Empty'}</span>
                           <span class="badge bg-${p?'success':'secondary'}">${p?'Ready':'Waiting'}</span>`;
            list.appendChild(li);
        });
        document.getElementById('player-count').textContent = players.filter(Boolean).length;
        document.getElementById('start-btn').disabled = players.filter(Boolean).length < 3 || !isHost;
    }

    function updateConnStatus(txt, cls) {
        const el = document.getElementById('conn-status');
        const el2 = document.getElementById('game-conn');
        el.textContent = txt;
        el.className = 'connection-status ' + cls;
        if (el2) el2.className = 'connection-status ' + cls;
    }

    function showWin(winner) {
        document.getElementById('win-message').innerHTML = `<h3>${winner === myId ? 'You Win!' : winner.slice(8) + ' Wins!'} ðŸŽ‰</h3><p>By Tong-Its!</p>`;
        new bootstrap.Modal(document.getElementById('winModal')).show();
    }

    function copyId() {
        navigator.clipboard.writeText(myId);
        alert('Copied!');
    }

    initPeer();
    updatePlayers();
</script>
</body>
</html>
